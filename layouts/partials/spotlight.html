<!-- Spotlight -->
<section class="spotlight {{ .style }}" id="{{ .title }}">
    <div class="content">
        {{ with .title }}<h2><a href="#{{ . }}" id="{{ . }}">{{ . }}</a></h2>{{ end }}
        {{ with .content }}<p>{{ . | safeHTML }}</p>{{ end }}
        {{ $gpx100 := printf "/gpx/kyivska_sotka_%s.gpx" .title }}
        {{ $gpx50 := printf "/gpx/kyivska_pivsotka_%s.gpx" .title }}
        <p>
            <div class="strava-embed-placeholder"
                data-embed-type="route"
                {{ with .strava_100_route_id }}data-embed-id="{{ . }}"{{ end }}
                data-units="metric"
                data-hide-elevation="true"
                data-style="standard"
                data-terrain="2d"
                data-map-hash="{{ .strava_100_route_map_hash }}"
                data-full-width="false"
                data-from-embed="true">
            </div>
            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    var placeholders = document.querySelectorAll('.strava-embed-placeholder');
                    var loadEmbedScript = function() {
                        if (!document.querySelector('script[src="https://strava-embeds.com/embed.js"]')) {
                            var script = document.createElement('script');
                            script.src = 'https://strava-embeds.com/embed.js';
                            document.body.appendChild(script);
                        }
                    };

                    // Lazy load on scroll for all placeholders
                    if ('IntersectionObserver' in window && placeholders.length) {
                        var observer = new IntersectionObserver(function(entries, observer) {
                            entries.forEach(function(entry) {
                                if (entry.isIntersecting) {
                                    loadEmbedScript();
                                    observer.unobserve(entry.target);
                                }
                            });
                        });
                        placeholders.forEach(function(placeholder) {
                            observer.observe(placeholder);
                        });
                    } else {
                        // Fallback: load immediately
                        loadEmbedScript();
                    }

                    // Load immediately if hash matches a section containing a placeholder
                    var hash = window.location.hash;
                    if (hash) {
                        var section = document.getElementById(hash.replace('#', ''));
                        if (section) {
                            var sectionPlaceholder = section.querySelector('.strava-embed-placeholder');
                            if (sectionPlaceholder) {
                                loadEmbedScript();
                            }
                        }
                    }

                    // Remove the Strava embed placeholder and its children
                    var placeholder = document.querySelector('.strava-embed-placeholder');
                    if (placeholder) {
                        placeholder.innerHTML = ''; // Remove embed content
                    }

                    // Optionally, remove the embed.js script if you want to fully unload
                    var embedScript = document.querySelector('script[src="https://strava-embeds.com/embed.js"]');
                    if (embedScript) {
                        embedScript.remove();
                    }
                });
            </script>
        </p>
        <ul class="actions">
            <li><a href="#home" class="button primary small icon fa-home smooth-scroll">Нагору</a></li>
            {{ with .official_100_route_url }}<li><a href="{{ . }}" class="button small" target="_blank">Official</a></li>{{ end }}
            {{ with .youtube }}<li><a href="{{ . }}" target="_blank" class="button small icon fa-video" target="_blank">Live</a></li>{{ end }}
            <li><a href="{{ $gpx100 }}" class="button small icon fa-download">GPX</a></li>
            {{ $gpx100Files := printf "[\"https://velosotka.github.io%s\"]" $gpx100 }}
            <li><a href="https://gpx.studio/app?files={{ $gpx100Files | safeHTMLAttr }}" class="button small" target="_blank">gpx.studio</a></li>
            {{ with .official_50_route_urL }}
                <li><a href="{{ . }}" class="button small primary" target="_blank">Official 50</a></li>
                <li><a href="{{ $gpx50 }}" class="button small icon fa-download">GPX 50</a></li>
            {{ end }}
            {{ with .strava_100_activity_id }}<li><a href="https://www.strava.com/activities/{{ . }}" class="button small" target="_blank">Учасник</a></li>{{ end }}
            </ul>
        </ul>
    </div>
    {{ with .image }}<div class="image">
        <img src="{{ . }}" alt="{{ . }}" />
    </div>{{ end }}
</section>
